<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>GLB Viewer</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      font-family: sans-serif;
      background-color: #ffffff;
    }
    #upload { display: none; }
    #homeIconBtn {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 10;
      width: 36px;
      height: 36px;
      padding: 0;
      background: #2b2b2b;
      color: #fff;
      border: 1px solid #555;
      border-radius: 4px;
      cursor: pointer;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #homeIconBtn:hover { background: #333; }
    #loadBtn {
      position: absolute;
      top: 10px;
      left: 56px;
      z-index: 10;
      padding: 6px 10px;
      background: #2b2b2b;
      color: #fff;
      border: 1px solid #555;
      border-radius: 4px;
      cursor: pointer;
    }
    #loadBtn:hover { background: #333; }
    #assembleBtn {
      position: absolute;
      top: 50px;
      left: 56px;
      z-index: 10;
      padding: 6px 10px;
      background: #2b2b2b;
      color: #fff;
      border: 1px solid #555;
      border-radius: 4px;
      cursor: pointer;
    }
    #assembleBtn:hover { background: #333; }
    #assembleBtn:disabled {
      background: #1a1a1a;
      color: #666;
      cursor: not-allowed;
    }
    #lightingControls {
      position: absolute;
      top: 90px;
      left: 56px;
      z-index: 10;
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    .lightBtn {
      padding: 6px 10px;
      background: #2b2b2b;
      color: #fff;
      border: 1px solid #555;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }
    .lightBtn:hover { background: #333; }
    .lightBtn.active {
      background: #4a90e2;
      border-color: #4a90e2;
    }
    #homeScreen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 1;
      transition: opacity 0.5s ease;
    }
    #homeScreen.hidden {
      opacity: 0;
      pointer-events: none;
    }
    .homeContent {
      text-align: center;
      color: white;
      max-width: 600px;
      padding: 40px;
    }
    .homeContent h1 {
      font-size: 48px;
      margin: 0 0 16px 0;
      font-weight: 300;
      letter-spacing: 2px;
    }
    .homeContent p {
      font-size: 18px;
      margin: 0 0 16px 0;
      opacity: 0.9;
      line-height: 1.6;
    }
    .homeContent .subtitle {
      font-size: 16px;
      margin: 0 0 40px 0;
      opacity: 0.85;
      font-style: italic;
      line-height: 1.5;
    }
    .homeButtons {
      display: flex;
      gap: 16px;
      justify-content: center;
      flex-wrap: wrap;
    }
    .homeBtn {
      padding: 14px 32px;
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: 2px solid rgba(255, 255, 255, 0.5);
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 500;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }
    .homeBtn:hover {
      background: rgba(255, 255, 255, 0.3);
      border-color: rgba(255, 255, 255, 0.8);
      transform: translateY(-2px);
    }
    .homeBtn.primary {
      background: white;
      color: #667eea;
      border-color: white;
    }
    .homeBtn.primary:hover {
      background: #f0f0f0;
      transform: translateY(-2px);
    }
    .features {
      margin-top: 48px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 20px;
      font-size: 14px;
      opacity: 0.8;
    }
    .feature {
      padding: 12px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 6px;
      backdrop-filter: blur(5px);
    }
    #zoomControls {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 10;
      display: flex;
      gap: 5px;
    }
    .zoomBtn {
      width: 36px;
      height: 36px;
      padding: 0;
      background: #2b2b2b;
      color: #fff;
      border: 1px solid #555;
      border-radius: 4px;
      cursor: pointer;
      font-size: 18px;
      line-height: 1;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .zoomBtn:hover { background: #333; }
    .zoomBtn:active { background: #444; }
  </style>
</head>
<body>
  <div id="homeScreen">
    <div class="homeContent">
      <h1>Archaeological Artifact Viewer</h1>
      <p>View, rotate, and reassemble 3D archaeological artifacts. Load your GLB model to explore fragments with interactive controls.</p>
      <p class="subtitle">Help archaeologists assemble artifacts! Who knows... you could put together the Holy Grail!</p>
      <div class="homeButtons">
        <button class="homeBtn primary" id="homeLoadBtn">Load 3D Model</button>
        <button class="homeBtn" id="homeDragBtn">Drag & Drop File</button>
      </div>
      <div class="features">
        <div class="feature">üîÑ Rotate & Pan</div>
        <div class="feature">üîç Zoom Controls</div>
        <div class="feature">üß© Auto-Assemble</div>
        <div class="feature">üí° Lighting Controls</div>
        <div class="feature">‚úã Drag Fragments</div>
      </div>
    </div>
  </div>
  <input type="file" id="upload" accept=".glb,.gltf" />
  <button id="homeIconBtn" title="Home">üè†</button>
  <button id="loadBtn">Load model‚Ä¶</button>
  <button id="assembleBtn" disabled>Auto-assemble</button>
  <div id="lightingControls">
    <button class="lightBtn" id="fullBrightBtn">Full Brightness</button>
    <button class="lightBtn active" id="resetLightBtn">Reset Lighting</button>
  </div>
  <div id="zoomControls">
    <button class="zoomBtn" id="zoomIn" title="Zoom In">+</button>
    <button class="zoomBtn" id="zoomOut" title="Zoom Out">‚àí</button>
  </div>
  <script type="importmap">
    {
      "imports": {
        "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
        "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
      }
    }
  </script>
  <script type="module">
    import * as THREE from 'three';
    import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
    import { DragControls } from 'three/addons/controls/DragControls.js';
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0xffffff);

    const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
    camera.position.set(0, 1, 3);

    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setPixelRatio(window.devicePixelRatio);
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.outputColorSpace = THREE.SRGBColorSpace;
    renderer.toneMapping = THREE.ACESFilmicToneMapping;
    renderer.toneMappingExposure = 1.3;
    renderer.shadowMap.enabled = false; // Disable shadows
    document.body.appendChild(renderer.domElement);

    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.enablePan = true;
    controls.screenSpacePanning = true;
    controls.minDistance = 0.1;
    controls.maxDistance = 100;

    // lights - bright and even coverage
    const ambientLight = new THREE.AmbientLight(0xffffff, 1.5);
    scene.add(ambientLight);
    
    const dirLight1 = new THREE.DirectionalLight(0xffffff, 1.0);
    dirLight1.position.set(5, 10, 7.5);
    scene.add(dirLight1);
    
    const dirLight2 = new THREE.DirectionalLight(0xffffff, 0.8);
    dirLight2.position.set(-5, 5, -5);
    scene.add(dirLight2);
    
    const dirLight3 = new THREE.DirectionalLight(0xffffff, 0.5);
    dirLight3.position.set(0, -5, 5);
    scene.add(dirLight3);
    
    // Store default light intensities
    const defaultLighting = {
      ambient: 1.5,
      dir1: 1.0,
      dir2: 0.8,
      dir3: 0.5,
      exposure: 1.3
    };

    const loader = new GLTFLoader();
    let currentModel = null;
    let draggableObjects = [];
    let dragControls = null;
    let originalPositions = new Map();
    let originalRotations = new Map();

    function clearCurrentModel() {
      if (currentModel) {
        scene.remove(currentModel);
        currentModel.traverse(obj => {
          if (obj.isMesh) {
            obj.geometry.dispose();
            if (obj.material) {
              const mats = Array.isArray(obj.material) ? obj.material : [obj.material];
              mats.forEach(m => {
                if (m.map) m.map.dispose();
                if (m.normalMap) m.normalMap.dispose();
                if (m.roughnessMap) m.roughnessMap.dispose();
                if (m.metalnessMap) m.metalnessMap.dispose();
                if (m.emissiveMap) m.emissiveMap.dispose();
                m.dispose?.();
              });
            }
          }
        });
        currentModel = null;
      }
      draggableObjects = [];
      if (dragControls) {
        dragControls.dispose();
        dragControls = null;
      }
    }

    function frameObject(object) {
      const box = new THREE.Box3().setFromObject(object);
      const size = box.getSize(new THREE.Vector3()).length();
      const center = box.getCenter(new THREE.Vector3());

      controls.target.copy(center);

      const fitOffset = 1.2;
      const fov = THREE.MathUtils.degToRad(camera.fov);
      let distance = size / (2 * Math.tan(fov / 2));
      distance *= fitOffset;

      const dir = new THREE.Vector3().subVectors(camera.position, controls.target).normalize();
      camera.position.copy(controls.target).addScaledVector(dir, distance);

      camera.near = distance / 100;
      camera.far = distance * 100;
      camera.updateProjectionMatrix();
      controls.update();
    }

    function loadFromURL(url) {
      loader.load(
        url,
        (gltf) => {
          clearCurrentModel();
          currentModel = gltf.scene;
          scene.add(currentModel);
          frameObject(currentModel);
          setupDraggableObjects();
        },
        undefined,
        (err) => {
          console.error('Failed to load model:', err);
          alert('Failed to load model. See console for details.');
        }
      );
    }

    function setupDraggableObjects() {
      draggableObjects = [];
      originalPositions.clear();
      originalRotations.clear();
      
      if (currentModel) {
        currentModel.traverse(obj => {
          if (obj.isMesh) {
            draggableObjects.push(obj);
            // Store original world positions and rotations
            const worldPos = new THREE.Vector3();
            const worldRot = new THREE.Quaternion();
            obj.getWorldPosition(worldPos);
            obj.getWorldQuaternion(worldRot);
            originalPositions.set(obj.uuid, worldPos.clone());
            originalRotations.set(obj.uuid, worldRot.clone());
          }
        });
      }
      
      // Enable assemble button
      const assembleBtn = document.getElementById('assembleBtn');
      if (draggableObjects.length > 1) {
        assembleBtn.disabled = false;
      }

      if (dragControls) {
        dragControls.dispose();
      }

      if (draggableObjects.length > 0) {
        dragControls = new DragControls(draggableObjects, camera, renderer.domElement);
        
        // Disable orbit controls while dragging
        dragControls.addEventListener('dragstart', () => {
          controls.enabled = false;
        });
        
        dragControls.addEventListener('dragend', () => {
          controls.enabled = true;
        });

        // Visual feedback
        dragControls.addEventListener('hoveron', (event) => {
          event.object.userData.originalMaterial = event.object.material;
          if (Array.isArray(event.object.material)) {
            event.object.material = event.object.material.map(mat => {
              const newMat = mat.clone();
              newMat.emissive.setHex(0x444444);
              return newMat;
            });
          } else {
            const newMat = event.object.material.clone();
            newMat.emissive.setHex(0x444444);
            event.object.material = newMat;
          }
        });

        dragControls.addEventListener('hoveroff', (event) => {
          if (event.object.userData.originalMaterial) {
            event.object.material = event.object.userData.originalMaterial;
            delete event.object.userData.originalMaterial;
          }
        });
      }
    }

    // Home screen
    const homeScreen = document.getElementById('homeScreen');
    const homeLoadBtn = document.getElementById('homeLoadBtn');
    const homeDragBtn = document.getElementById('homeDragBtn');
    
    function hideHomeScreen() {
      homeScreen.classList.add('hidden');
      setTimeout(() => {
        homeScreen.style.display = 'none';
      }, 500);
    }
    
    homeLoadBtn.addEventListener('click', () => {
      upload.click();
    });
    
    homeDragBtn.addEventListener('click', () => {
      hideHomeScreen();
    });
    
    // Home icon button
    const homeIconBtn = document.getElementById('homeIconBtn');
    homeIconBtn.addEventListener('click', () => {
      homeScreen.style.display = 'flex';
      homeScreen.classList.remove('hidden');
    });
    
    // File input
    const upload = document.getElementById('upload');
    const loadBtn = document.getElementById('loadBtn');
    loadBtn.addEventListener('click', () => upload.click());
    upload.addEventListener('change', (event) => {
      const file = event.target.files?.[0];
      if (!file) return;
      if (!file.name.toLowerCase().endsWith('.glb') && !file.name.toLowerCase().endsWith('.gltf')) {
        alert('Please select a .glb or .gltf file.');
        return;
      }
      hideHomeScreen();
      const objectURL = URL.createObjectURL(file);
      loadFromURL(objectURL);
    });

    // Drag and drop
    function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      renderer.domElement.addEventListener(eventName, preventDefaults, false);
      document.body.addEventListener(eventName, preventDefaults, false);
    });
    document.body.addEventListener('drop', (e) => {
      const dt = e.dataTransfer;
      const files = dt.files;
      if (files && files[0]) {
        const file = files[0];
        if (file.name.toLowerCase().endsWith('.glb') || file.name.toLowerCase().endsWith('.gltf')) {
          hideHomeScreen();
          const objectURL = URL.createObjectURL(file);
          loadFromURL(objectURL);
        } else {
          alert('Dropped file is not a .glb or .gltf.');
        }
      }
    });

    // URL param ?src=...
    const params = new URLSearchParams(window.location.search);
    const src = params.get('src');
    if (src) {
      loadFromURL(src);
    }

    // Auto-assemble function
    function autoAssemble() {
      if (draggableObjects.length < 2) {
        console.log('Need at least 2 objects');
        return;
      }
      
      console.log('Auto-assemble starting with', draggableObjects.length, 'objects');
      
      const assembleBtn = document.getElementById('assembleBtn');
      assembleBtn.disabled = true;
      assembleBtn.textContent = 'Assembling...';
      
      // Get current state
      const initialStates = new Map();
      draggableObjects.forEach(obj => {
        const worldPos = new THREE.Vector3();
        obj.getWorldPosition(worldPos);
        initialStates.set(obj.uuid, worldPos.clone());
      });
      
      // Calculate centroid of all pieces
      const centroid = new THREE.Vector3();
      let count = 0;
      draggableObjects.forEach(obj => {
        const worldPos = new THREE.Vector3();
        obj.getWorldPosition(worldPos);
        centroid.add(worldPos);
        count++;
      });
      centroid.divideScalar(count);
      
      console.log('Centroid:', centroid);
      
      // Calculate target positions - move each piece 100% toward centroid
      const targetPositions = new Map();
      draggableObjects.forEach(obj => {
        const worldPos = new THREE.Vector3();
        obj.getWorldPosition(worldPos);
        
        const toCenter = new THREE.Vector3().subVectors(centroid, worldPos);
        const targetPos = worldPos.clone().add(toCenter.multiplyScalar(1.0));
        
        targetPositions.set(obj.uuid, targetPos);
        console.log('Object', obj.uuid.substring(0, 8), 'from', worldPos, 'to', targetPos);
      });
      
      // Animate assembly
      const duration = 1500; // 1.5 seconds
      const startTime = Date.now();
      
      function animateAssembly() {
        const elapsed = Date.now() - startTime;
        const progress = Math.min(elapsed / duration, 1);
        
        // Easing function (ease-in-out)
        const eased = progress < 0.5 
          ? 2 * progress * progress 
          : 1 - Math.pow(-2 * progress + 2, 2) / 2;
        
        draggableObjects.forEach(obj => {
          const initial = initialStates.get(obj.uuid);
          const target = targetPositions.get(obj.uuid);
          
          if (initial && target) {
            // Interpolate world position
            const worldPos = new THREE.Vector3().lerpVectors(initial, target, eased);
            
            // Convert to local space
            if (obj.parent) {
              const localPos = obj.parent.worldToLocal(worldPos.clone());
              obj.position.copy(localPos);
            } else {
              obj.position.copy(worldPos);
            }
          }
        });
        
        if (progress < 1) {
          requestAnimationFrame(animateAssembly);
        } else {
          console.log('Assembly complete');
          assembleBtn.disabled = false;
          assembleBtn.textContent = 'Auto-assemble';
          frameObject(currentModel);
        }
      }
      
      console.log('Starting animation');
      animateAssembly();
    }
    
    const assembleBtn = document.getElementById('assembleBtn');
    assembleBtn.addEventListener('click', autoAssemble);
    
    // Lighting controls
    const fullBrightBtn = document.getElementById('fullBrightBtn');
    const resetLightBtn = document.getElementById('resetLightBtn');
    
    fullBrightBtn.addEventListener('click', () => {
      // Full brightness from all angles
      ambientLight.intensity = 2.5;
      dirLight1.intensity = 1.5;
      dirLight2.intensity = 1.5;
      dirLight3.intensity = 1.5;
      renderer.toneMappingExposure = 1.8;
      
      fullBrightBtn.classList.add('active');
      resetLightBtn.classList.remove('active');
    });
    
    resetLightBtn.addEventListener('click', () => {
      // Reset to default lighting
      ambientLight.intensity = defaultLighting.ambient;
      dirLight1.intensity = defaultLighting.dir1;
      dirLight2.intensity = defaultLighting.dir2;
      dirLight3.intensity = defaultLighting.dir3;
      renderer.toneMappingExposure = defaultLighting.exposure;
      
      resetLightBtn.classList.add('active');
      fullBrightBtn.classList.remove('active');
    });
    
    // Zoom controls
    const zoomInBtn = document.getElementById('zoomIn');
    const zoomOutBtn = document.getElementById('zoomOut');
    
    zoomInBtn.addEventListener('click', () => {
      const direction = new THREE.Vector3();
      camera.getWorldDirection(direction);
      const distance = camera.position.distanceTo(controls.target);
      const zoomAmount = distance * 0.2;
      camera.position.addScaledVector(direction, zoomAmount);
      controls.update();
    });
    
    zoomOutBtn.addEventListener('click', () => {
      const direction = new THREE.Vector3();
      camera.getWorldDirection(direction);
      const distance = camera.position.distanceTo(controls.target);
      const zoomAmount = distance * 0.2;
      camera.position.addScaledVector(direction, -zoomAmount);
      controls.update();
    });

    window.addEventListener('resize', () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });

    function animate() {
      requestAnimationFrame(animate);
      controls.update();
      renderer.render(scene, camera);
    }
    animate();
  </script>
</body>
</html>
