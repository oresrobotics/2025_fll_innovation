<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>GLB Viewer</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      font-family: sans-serif;
      background-color: #ffffff;
    }
    #upload { display: none; }
    #homeIconBtn {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 10;
      width: 36px;
      height: 36px;
      padding: 0;
      background: #2b2b2b;
      color: #fff;
      border: 1px solid #555;
      border-radius: 4px;
      cursor: pointer;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #homeIconBtn:hover { background: #333; }
    #loadBtn {
      position: absolute;
      top: 10px;
      left: 56px;
      z-index: 10;
      padding: 6px 10px;
      background: #2b2b2b;
      color: #fff;
      border: 1px solid #555;
      border-radius: 4px;
      cursor: pointer;
    }
    #loadBtn:hover { background: #333; }
    #assembleBtn {
      position: absolute;
      top: 50px;
      left: 56px;
      z-index: 10;
      padding: 6px 10px;
      background: #2b2b2b;
      color: #fff;
      border: 1px solid #555;
      border-radius: 4px;
      cursor: pointer;
    }
    #assembleBtn:hover { background: #333; }
    #assembleBtn:disabled {
      background: #1a1a1a;
      color: #666;
      cursor: not-allowed;
    }
    #lightingControls {
      position: absolute;
      top: 90px;
      left: 56px;
      z-index: 10;
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    #downloadBtn {
      position: absolute;
      top: 170px;
      left: 56px;
      z-index: 10;
      padding: 6px 10px;
      background: #2b2b2b;
      color: #fff;
      border: 1px solid #555;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }
    #downloadBtn:hover { background: #333; }
    #downloadBtn:disabled {
      background: #1a1a1a;
      color: #666;
      cursor: not-allowed;
    }
    #sliceModeBtn {
      position: absolute;
      top: 56px;
      right: 10px;
      z-index: 10;
      padding: 6px 10px;
      background: #2b2b2b;
      color: #fff;
      border: 1px solid #555;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }
    #sliceModeBtn:hover { background: #333; }
    #sliceModeBtn.active {
      background: #4a90e2;
      border-color: #4a90e2;
    }
    #slicingControls {
      position: absolute;
      top: 96px;
      right: 10px;
      z-index: 10;
      display: flex;
      flex-direction: column;
      gap: 8px;
      background: rgba(43, 43, 43, 0.95);
      padding: 12px;
      border-radius: 6px;
      border: 1px solid #555;
      width: 180px;
    }
    #slicingControls.hidden {
      display: none;
    }
    .sliceBtn {
      padding: 6px 10px;
      background: #2b2b2b;
      color: #fff;
      border: 1px solid #555;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }
    .sliceBtn:hover { background: #333; }
    .sliceControl {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .sliceControl label {
      color: #fff;
      font-size: 11px;
      text-transform: uppercase;
    }
    .sliceControl input[type="range"] {
      width: 100%;
      cursor: pointer;
    }
    #zoomControls {
      padding: 6px 10px;
      background: #2b2b2b;
      color: #fff;
      border: 1px solid #555;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }
    .lightBtn:hover { background: #333; }
    .lightBtn.active {
      background: #4a90e2;
      border-color: #4a90e2;
    }
    #homeScreen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 1;
      transition: opacity 0.5s ease;
    }
    #homeScreen.hidden {
      opacity: 0;
      pointer-events: none;
    }
    .homeContent {
      text-align: center;
      color: white;
      max-width: 600px;
      padding: 40px;
    }
    .homeContent h1 {
      font-size: 48px;
      margin: 0 0 16px 0;
      font-weight: 300;
      letter-spacing: 2px;
    }
    .homeContent p {
      font-size: 18px;
      margin: 0 0 16px 0;
      opacity: 0.9;
      line-height: 1.6;
    }
    .homeContent .subtitle {
      font-size: 16px;
      margin: 0 0 40px 0;
      opacity: 0.85;
      font-style: italic;
      line-height: 1.5;
    }
    .homeButtons {
      display: flex;
      gap: 16px;
      justify-content: center;
      flex-wrap: wrap;
    }
    .homeBtn {
      padding: 14px 32px;
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: 2px solid rgba(255, 255, 255, 0.5);
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 500;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }
    .homeBtn:hover {
      background: rgba(255, 255, 255, 0.3);
      border-color: rgba(255, 255, 255, 0.8);
      transform: translateY(-2px);
    }
    .homeBtn.primary {
      background: white;
      color: #667eea;
      border-color: white;
    }
    .homeBtn.primary:hover {
      background: #f0f0f0;
      transform: translateY(-2px);
    }
    .features {
      margin-top: 48px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 20px;
      font-size: 14px;
      opacity: 0.8;
    }
    .feature {
      padding: 12px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 6px;
      backdrop-filter: blur(5px);
    }
    #authScreen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1001;
      opacity: 1;
      transition: opacity 0.5s ease;
    }
    #authScreen.hidden {
      opacity: 0;
      pointer-events: none;
    }
    .authContainer {
      background: white;
      border-radius: 12px;
      padding: 40px;
      width: 400px;
      max-width: 90%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }
    .authContainer h2 {
      margin: 0 0 8px 0;
      color: #333;
      font-size: 28px;
      font-weight: 300;
    }
    .authContainer .authSubtitle {
      color: #666;
      margin: 0 0 32px 0;
      font-size: 14px;
    }
    .authForm {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .authForm.hidden {
      display: none;
    }
    .formGroup {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .formGroup label {
      color: #555;
      font-size: 14px;
      font-weight: 500;
    }
    .formGroup input {
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      font-family: sans-serif;
      transition: border-color 0.3s;
    }
    .formGroup input:focus {
      outline: none;
      border-color: #667eea;
    }
    .authBtn {
      padding: 12px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.3s;
      margin-top: 8px;
    }
    .authBtn:hover {
      background: #5568d3;
    }
    .authToggle {
      text-align: center;
      margin-top: 24px;
      color: #666;
      font-size: 14px;
    }
    .authToggle a {
      color: #667eea;
      cursor: pointer;
      text-decoration: none;
      font-weight: 500;
    }
    .authToggle a:hover {
      text-decoration: underline;
    }
    .guestBtn {
      margin-top: 16px;
      padding: 12px;
      background: transparent;
      color: #667eea;
      border: 2px solid #667eea;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s;
    }
    .guestBtn:hover {
      background: #667eea;
      color: white;
    }
    #signOutBtn {
      position: absolute;
      top: 20px;
      right: 20px;
      padding: 8px 16px;
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: 2px solid rgba(255, 255, 255, 0.5);
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
    }
    #signOutBtn:hover { 
      background: rgba(255, 255, 255, 0.3);
      border-color: rgba(255, 255, 255, 0.8);
    }
    #zoomControls {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 10;
      display: flex;
      gap: 5px;
    }
    .zoomBtn {
      width: 36px;
      height: 36px;
      padding: 0;
      background: #2b2b2b;
      color: #fff;
      border: 1px solid #555;
      border-radius: 4px;
      cursor: pointer;
      font-size: 18px;
      line-height: 1;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .zoomBtn:hover { background: #333; }
    .zoomBtn:active { background: #444; }
  </style>
</head>
<body>
  <div id="authScreen">
    <div class="authContainer">
      <!-- Sign In Form -->
      <div id="signInForm" class="authForm">
        <h2>Welcome Back</h2>
        <p class="authSubtitle">Sign in to continue your artifact exploration</p>
        <div class="formGroup">
          <label for="signInEmail">Email</label>
          <input type="email" id="signInEmail" placeholder="your@email.com" required>
        </div>
        <div class="formGroup">
          <label for="signInPassword">Password</label>
          <input type="password" id="signInPassword" placeholder="Enter your password" required>
        </div>
        <button class="authBtn" id="signInBtn">Sign In</button>
        <button class="guestBtn" id="continueAsGuest1">Continue as Guest</button>
        <div class="authToggle">
          Don't have an account? <a id="showSignUp">Sign up</a>
        </div>
      </div>
      
      <!-- Sign Up Form -->
      <div id="signUpForm" class="authForm hidden">
        <h2>Create Account</h2>
        <p class="authSubtitle">Join us in reconstructing history</p>
        <div class="formGroup">
          <label for="signUpName">Full Name</label>
          <input type="text" id="signUpName" placeholder="John Doe" required>
        </div>
        <div class="formGroup">
          <label for="signUpEmail">Email</label>
          <input type="email" id="signUpEmail" placeholder="your@email.com" required>
        </div>
        <div class="formGroup">
          <label for="signUpPassword">Password</label>
          <input type="password" id="signUpPassword" placeholder="Create a password" required>
        </div>
        <div class="formGroup">
          <label for="signUpPasswordConfirm">Confirm Password</label>
          <input type="password" id="signUpPasswordConfirm" placeholder="Confirm your password" required>
        </div>
        <button class="authBtn" id="signUpBtn">Sign Up</button>
        <button class="guestBtn" id="continueAsGuest2">Continue as Guest</button>
        <div class="authToggle">
          Already have an account? <a id="showSignIn">Sign in</a>
        </div>
      </div>
    </div>
  </div>
  
  <div id="homeScreen" class="hidden">
    <button id="signOutBtn">Sign Out</button>
    <div class="homeContent">
      <h1>Archaeological Artifact Viewer</h1>
      <p>View, rotate, and reassemble 3D archaeological artifacts. Load your GLB model to explore fragments with interactive controls.</p>
      <p class="subtitle">Help archaeologists assemble artifacts! Who knows... you could put together the Holy Grail!</p>
      <div class="homeButtons">
        <button class="homeBtn primary" id="homeLoadBtn">Load 3D Model</button>
        <button class="homeBtn" id="homeDragBtn">Drag & Drop File</button>
      </div>
      <div class="features">
        <div class="feature">🔄 Rotate & Pan</div>
        <div class="feature">🔍 Zoom Controls</div>
        <div class="feature">🧩 Auto-Assemble</div>
        <div class="feature">💡 Lighting Controls</div>
        <div class="feature">✋ Drag Fragments</div>
      </div>
    </div>
  </div>
  <input type="file" id="upload" accept=".glb,.gltf" />
  <button id="homeIconBtn" title="Home">🏠</button>
  <button id="loadBtn">Load model…</button>
  <button id="assembleBtn" disabled>Auto-assemble</button>
  <div id="lightingControls">
    <button class="lightBtn" id="fullBrightBtn">Full Brightness</button>
    <button class="lightBtn active" id="resetLightBtn">Reset Lighting</button>
  </div>
  <button id="downloadBtn" disabled>Download GLB</button>
  <div id="zoomControls">
    <button class="zoomBtn" id="zoomIn" title="Zoom In">+</button>
    <button class="zoomBtn" id="zoomOut" title="Zoom Out">−</button>
  </div>
  <button id="sliceModeBtn">Slicing Mode</button>
  <div id="slicingControls" class="hidden">
    <div class="sliceControl">
      <label>Position</label>
      <input type="range" id="slicePosition" min="-1" max="1" step="0.01" value="0">
    </div>
    <div class="sliceControl">
      <label>Axis</label>
      <select id="sliceAxis" style="padding: 4px; border-radius: 4px; background: #1a1a1a; color: #fff; border: 1px solid #555;">
        <option value="x">X-Axis</option>
        <option value="y" selected>Y-Axis</option>
        <option value="z">Z-Axis</option>
      </select>
    </div>
    <button class="sliceBtn" id="flipSliceBtn">Flip Direction</button>
  </div>
  <script type="importmap">
    {
      "imports": {
        "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
        "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
      }
    }
  </script>
  <script type="module">
    import * as THREE from 'three';
    import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
    import { GLTFExporter } from 'three/addons/exporters/GLTFExporter.js';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
    import { DragControls } from 'three/addons/controls/DragControls.js';
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0xffffff);

    const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
    camera.position.set(0, 1, 3);

    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setPixelRatio(window.devicePixelRatio);
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.outputColorSpace = THREE.SRGBColorSpace;
    renderer.toneMapping = THREE.ACESFilmicToneMapping;
    renderer.toneMappingExposure = 1.3;
    renderer.shadowMap.enabled = false; // Disable shadows
    renderer.localClippingEnabled = true; // Enable clipping
    document.body.appendChild(renderer.domElement);

    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.enablePan = true;
    controls.screenSpacePanning = true;
    controls.minDistance = 0.1;
    controls.maxDistance = 100;

    // lights - bright and even coverage
    const ambientLight = new THREE.AmbientLight(0xffffff, 1.5);
    scene.add(ambientLight);
    
    const dirLight1 = new THREE.DirectionalLight(0xffffff, 1.0);
    dirLight1.position.set(5, 10, 7.5);
    scene.add(dirLight1);
    
    const dirLight2 = new THREE.DirectionalLight(0xffffff, 0.8);
    dirLight2.position.set(-5, 5, -5);
    scene.add(dirLight2);
    
    const dirLight3 = new THREE.DirectionalLight(0xffffff, 0.5);
    dirLight3.position.set(0, -5, 5);
    scene.add(dirLight3);
    
    // Store default light intensities
    const defaultLighting = {
      ambient: 1.5,
      dir1: 1.0,
      dir2: 0.8,
      dir3: 0.5,
      exposure: 1.3
    };

    const loader = new GLTFLoader();
    let currentModel = null;
    let draggableObjects = [];
    let dragControls = null;
    let originalPositions = new Map();
    let originalRotations = new Map();
    let clippingPlane = new THREE.Plane(new THREE.Vector3(0, -1, 0), 0);
    let slicingEnabled = false;

    function clearCurrentModel() {
      if (currentModel) {
        scene.remove(currentModel);
        currentModel.traverse(obj => {
          if (obj.isMesh) {
            obj.geometry.dispose();
            if (obj.material) {
              const mats = Array.isArray(obj.material) ? obj.material : [obj.material];
              mats.forEach(m => {
                if (m.map) m.map.dispose();
                if (m.normalMap) m.normalMap.dispose();
                if (m.roughnessMap) m.roughnessMap.dispose();
                if (m.metalnessMap) m.metalnessMap.dispose();
                if (m.emissiveMap) m.emissiveMap.dispose();
                m.dispose?.();
              });
            }
          }
        });
        currentModel = null;
      }
      draggableObjects = [];
      if (dragControls) {
        dragControls.dispose();
        dragControls = null;
      }
    }

    function frameObject(object) {
      const box = new THREE.Box3().setFromObject(object);
      const size = box.getSize(new THREE.Vector3()).length();
      const center = box.getCenter(new THREE.Vector3());

      controls.target.copy(center);

      const fitOffset = 1.2;
      const fov = THREE.MathUtils.degToRad(camera.fov);
      let distance = size / (2 * Math.tan(fov / 2));
      distance *= fitOffset;

      const dir = new THREE.Vector3().subVectors(camera.position, controls.target).normalize();
      camera.position.copy(controls.target).addScaledVector(dir, distance);

      camera.near = distance / 100;
      camera.far = distance * 100;
      camera.updateProjectionMatrix();
      controls.update();
    }

    function loadFromURL(url) {
      loader.load(
        url,
        (gltf) => {
          clearCurrentModel();
          currentModel = gltf.scene;
          scene.add(currentModel);
          frameObject(currentModel);
          setupDraggableObjects();
        },
        undefined,
        (err) => {
          console.error('Failed to load model:', err);
          alert('Failed to load model. See console for details.');
        }
      );
    }

    function setupDraggableObjects() {
      draggableObjects = [];
      originalPositions.clear();
      originalRotations.clear();
      
      if (currentModel) {
        currentModel.traverse(obj => {
          if (obj.isMesh) {
            draggableObjects.push(obj);
            // Store original world positions and rotations
            const worldPos = new THREE.Vector3();
            const worldRot = new THREE.Quaternion();
            obj.getWorldPosition(worldPos);
            obj.getWorldQuaternion(worldRot);
            originalPositions.set(obj.uuid, worldPos.clone());
            originalRotations.set(obj.uuid, worldRot.clone());
          }
        });
      }
      
      // Enable assemble and download buttons
      const assembleBtn = document.getElementById('assembleBtn');
      const downloadBtn = document.getElementById('downloadBtn');
      if (draggableObjects.length > 1) {
        assembleBtn.disabled = false;
      }
      if (draggableObjects.length > 0) {
        downloadBtn.disabled = false;
      }

      if (dragControls) {
        dragControls.dispose();
      }

      if (draggableObjects.length > 0) {
        dragControls = new DragControls(draggableObjects, camera, renderer.domElement);
        
        // Disable orbit controls while dragging
        dragControls.addEventListener('dragstart', () => {
          controls.enabled = false;
        });
        
        dragControls.addEventListener('dragend', () => {
          controls.enabled = true;
        });

        // Visual feedback
        dragControls.addEventListener('hoveron', (event) => {
          event.object.userData.originalMaterial = event.object.material;
          if (Array.isArray(event.object.material)) {
            event.object.material = event.object.material.map(mat => {
              const newMat = mat.clone();
              newMat.emissive.setHex(0x444444);
              return newMat;
            });
          } else {
            const newMat = event.object.material.clone();
            newMat.emissive.setHex(0x444444);
            event.object.material = newMat;
          }
        });

        dragControls.addEventListener('hoveroff', (event) => {
          if (event.object.userData.originalMaterial) {
            event.object.material = event.object.userData.originalMaterial;
            delete event.object.userData.originalMaterial;
          }
        });
      }
    }

    // Get all screen elements first
    const authScreen = document.getElementById('authScreen');
    const homeScreen = document.getElementById('homeScreen');
    
    // Auth screen elements
    const signInForm = document.getElementById('signInForm');
    const signUpForm = document.getElementById('signUpForm');
    const showSignUpLink = document.getElementById('showSignUp');
    const showSignInLink = document.getElementById('showSignIn');
    const signInBtn = document.getElementById('signInBtn');
    const signUpBtn = document.getElementById('signUpBtn');
    const continueAsGuest1 = document.getElementById('continueAsGuest1');
    const continueAsGuest2 = document.getElementById('continueAsGuest2');
    
    function hideAuthScreen() {
      authScreen.classList.add('hidden');
      setTimeout(() => {
        authScreen.style.display = 'none';
      }, 500);
    }
    
    function showHomeScreen() {
      hideAuthScreen();
      setTimeout(() => {
        homeScreen.style.display = 'flex';
        homeScreen.classList.remove('hidden');
      }, 500);
    }
    
    function hideHomeScreen() {
      homeScreen.classList.add('hidden');
      setTimeout(() => {
        homeScreen.style.display = 'none';
      }, 500);
    }
    
    // Toggle between sign in and sign up
    showSignUpLink.addEventListener('click', () => {
      signInForm.classList.add('hidden');
      signUpForm.classList.remove('hidden');
    });
    
    showSignInLink.addEventListener('click', () => {
      signUpForm.classList.add('hidden');
      signInForm.classList.remove('hidden');
    });
    
    // Sign in
    signInBtn.addEventListener('click', (e) => {
      e.preventDefault();
      const email = document.getElementById('signInEmail').value;
      const password = document.getElementById('signInPassword').value;
      
      if (email && password) {
        console.log('Sign in:', email);
        // Store user info (frontend only)
        localStorage.setItem('userEmail', email);
        localStorage.setItem('userName', email.split('@')[0]);
        showHomeScreen();
      } else {
        alert('Please fill in all fields');
      }
    });
    
    // Sign up
    signUpBtn.addEventListener('click', (e) => {
      e.preventDefault();
      const name = document.getElementById('signUpName').value;
      const email = document.getElementById('signUpEmail').value;
      const password = document.getElementById('signUpPassword').value;
      const passwordConfirm = document.getElementById('signUpPasswordConfirm').value;
      
      if (name && email && password && passwordConfirm) {
        if (password !== passwordConfirm) {
          alert('Passwords do not match');
          return;
        }
        console.log('Sign up:', name, email);
        // Store user info (frontend only)
        localStorage.setItem('userEmail', email);
        localStorage.setItem('userName', name);
        showHomeScreen();
      } else {
        alert('Please fill in all fields');
      }
    });
    
    // Continue as guest
    continueAsGuest1.addEventListener('click', () => {
      localStorage.setItem('userEmail', 'guest');
      localStorage.setItem('userName', 'Guest');
      showHomeScreen();
    });
    
    continueAsGuest2.addEventListener('click', () => {
      localStorage.setItem('userEmail', 'guest');
      localStorage.setItem('userName', 'Guest');
      showHomeScreen();
    });
    
    // Check if user is already logged in
    const userEmail = localStorage.getItem('userEmail');
    if (userEmail) {
      // Already logged in, skip auth screen
      hideAuthScreen();
      homeScreen.style.display = 'flex';
      homeScreen.classList.remove('hidden');
    }
    
    // Home screen buttons
    const homeLoadBtn = document.getElementById('homeLoadBtn');
    const homeDragBtn = document.getElementById('homeDragBtn');
    
    homeLoadBtn.addEventListener('click', () => {
      upload.click();
    });
    
    homeDragBtn.addEventListener('click', () => {
      hideHomeScreen();
    });
    
    // Home icon button
    const homeIconBtn = document.getElementById('homeIconBtn');
    homeIconBtn.addEventListener('click', () => {
      homeScreen.style.display = 'flex';
      homeScreen.classList.remove('hidden');
    });
    
    // Sign out button
    const signOutBtn = document.getElementById('signOutBtn');
    signOutBtn.addEventListener('click', () => {
      // Clear user data
      localStorage.removeItem('userEmail');
      localStorage.removeItem('userName');
      
      // Hide all screens
      homeScreen.classList.add('hidden');
      homeScreen.style.display = 'none';
      
      // Show auth screen and reset to sign in form
      authScreen.style.display = 'flex';
      authScreen.classList.remove('hidden');
      signUpForm.classList.add('hidden');
      signInForm.classList.remove('hidden');
      
      // Clear form fields
      document.getElementById('signInEmail').value = '';
      document.getElementById('signInPassword').value = '';
      document.getElementById('signUpName').value = '';
      document.getElementById('signUpEmail').value = '';
      document.getElementById('signUpPassword').value = '';
      document.getElementById('signUpPasswordConfirm').value = '';
    });
    
    // File input
    const upload = document.getElementById('upload');
    const loadBtn = document.getElementById('loadBtn');
    loadBtn.addEventListener('click', () => upload.click());
    upload.addEventListener('change', (event) => {
      const file = event.target.files?.[0];
      if (!file) return;
      if (!file.name.toLowerCase().endsWith('.glb') && !file.name.toLowerCase().endsWith('.gltf')) {
        alert('Please select a .glb or .gltf file.');
        return;
      }
      hideHomeScreen();
      const objectURL = URL.createObjectURL(file);
      loadFromURL(objectURL);
    });

    // Drag and drop
    function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      renderer.domElement.addEventListener(eventName, preventDefaults, false);
      document.body.addEventListener(eventName, preventDefaults, false);
    });
    document.body.addEventListener('drop', (e) => {
      const dt = e.dataTransfer;
      const files = dt.files;
      if (files && files[0]) {
        const file = files[0];
        if (file.name.toLowerCase().endsWith('.glb') || file.name.toLowerCase().endsWith('.gltf')) {
          hideHomeScreen();
          const objectURL = URL.createObjectURL(file);
          loadFromURL(objectURL);
        } else {
          alert('Dropped file is not a .glb or .gltf.');
        }
      }
    });

    // URL param ?src=...
    const params = new URLSearchParams(window.location.search);
    const src = params.get('src');
    if (src) {
      loadFromURL(src);
    }

    // Auto-assemble function
    function autoAssemble() {
      if (draggableObjects.length < 2) {
        console.log('Need at least 2 objects');
        return;
      }
      
      console.log('Auto-assemble starting with', draggableObjects.length, 'objects');
      
      const assembleBtn = document.getElementById('assembleBtn');
      assembleBtn.disabled = true;
      assembleBtn.textContent = 'Assembling...';
      
      // Get current state
      const initialStates = new Map();
      draggableObjects.forEach(obj => {
        const worldPos = new THREE.Vector3();
        obj.getWorldPosition(worldPos);
        initialStates.set(obj.uuid, worldPos.clone());
      });
      
      // Calculate centroid of all pieces
      const centroid = new THREE.Vector3();
      let count = 0;
      draggableObjects.forEach(obj => {
        const worldPos = new THREE.Vector3();
        obj.getWorldPosition(worldPos);
        centroid.add(worldPos);
        count++;
      });
      centroid.divideScalar(count);
      
      console.log('Centroid:', centroid);
      
      // Calculate target positions - move each piece 100% toward centroid
      const targetPositions = new Map();
      draggableObjects.forEach(obj => {
        const worldPos = new THREE.Vector3();
        obj.getWorldPosition(worldPos);
        
        const toCenter = new THREE.Vector3().subVectors(centroid, worldPos);
        const targetPos = worldPos.clone().add(toCenter.multiplyScalar(1.0));
        
        targetPositions.set(obj.uuid, targetPos);
        console.log('Object', obj.uuid.substring(0, 8), 'from', worldPos, 'to', targetPos);
      });
      
      // Animate assembly
      const duration = 1500; // 1.5 seconds
      const startTime = Date.now();
      
      function animateAssembly() {
        const elapsed = Date.now() - startTime;
        const progress = Math.min(elapsed / duration, 1);
        
        // Easing function (ease-in-out)
        const eased = progress < 0.5 
          ? 2 * progress * progress 
          : 1 - Math.pow(-2 * progress + 2, 2) / 2;
        
        draggableObjects.forEach(obj => {
          const initial = initialStates.get(obj.uuid);
          const target = targetPositions.get(obj.uuid);
          
          if (initial && target) {
            // Interpolate world position
            const worldPos = new THREE.Vector3().lerpVectors(initial, target, eased);
            
            // Convert to local space
            if (obj.parent) {
              const localPos = obj.parent.worldToLocal(worldPos.clone());
              obj.position.copy(localPos);
            } else {
              obj.position.copy(worldPos);
            }
          }
        });
        
        if (progress < 1) {
          requestAnimationFrame(animateAssembly);
        } else {
          console.log('Assembly complete');
          assembleBtn.disabled = false;
          assembleBtn.textContent = 'Auto-assemble';
          frameObject(currentModel);
        }
      }
      
      console.log('Starting animation');
      animateAssembly();
    }
    
    const assembleBtn = document.getElementById('assembleBtn');
    assembleBtn.addEventListener('click', autoAssemble);
    
    // Lighting controls
    const fullBrightBtn = document.getElementById('fullBrightBtn');
    const resetLightBtn = document.getElementById('resetLightBtn');
    
    fullBrightBtn.addEventListener('click', () => {
      // Full brightness from all angles
      ambientLight.intensity = 2.5;
      dirLight1.intensity = 1.5;
      dirLight2.intensity = 1.5;
      dirLight3.intensity = 1.5;
      renderer.toneMappingExposure = 1.8;
      
      fullBrightBtn.classList.add('active');
      resetLightBtn.classList.remove('active');
    });
    
    resetLightBtn.addEventListener('click', () => {
      // Reset to default lighting
      ambientLight.intensity = defaultLighting.ambient;
      dirLight1.intensity = defaultLighting.dir1;
      dirLight2.intensity = defaultLighting.dir2;
      dirLight3.intensity = defaultLighting.dir3;
      renderer.toneMappingExposure = defaultLighting.exposure;
      
      resetLightBtn.classList.add('active');
      fullBrightBtn.classList.remove('active');
    });
    
    // Download button
    const downloadBtn = document.getElementById('downloadBtn');
    downloadBtn.addEventListener('click', () => {
      if (!currentModel) return;
      
      downloadBtn.disabled = true;
      downloadBtn.textContent = 'Exporting...';
      
      const exporter = new GLTFExporter();
      
      exporter.parse(
        currentModel,
        (gltf) => {
          // Convert to JSON string
          const output = JSON.stringify(gltf, null, 2);
          
          // Create blob and download
          const blob = new Blob([output], { type: 'text/plain' });
          const url = URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.href = url;
          link.download = 'modified-artifact.gltf';
          link.click();
          URL.revokeObjectURL(url);
          
          downloadBtn.disabled = false;
          downloadBtn.textContent = 'Download GLB';
        },
        (error) => {
          console.error('Export error:', error);
          alert('Failed to export model');
          downloadBtn.disabled = false;
          downloadBtn.textContent = 'Download GLB';
        },
        { binary: false }
      );
    });
    
    // Slicing mode
    const sliceModeBtn = document.getElementById('sliceModeBtn');
    const slicingControls = document.getElementById('slicingControls');
    const slicePosition = document.getElementById('slicePosition');
    const sliceAxis = document.getElementById('sliceAxis');
    const flipSliceBtn = document.getElementById('flipSliceBtn');
    let sliceDirection = -1;
    
    sliceModeBtn.addEventListener('click', () => {
      slicingEnabled = !slicingEnabled;
      
      if (slicingEnabled) {
        sliceModeBtn.classList.add('active');
        sliceModeBtn.textContent = 'Exit Slicing';
        slicingControls.classList.remove('hidden');
        updateSlicing();
      } else {
        sliceModeBtn.classList.remove('active');
        sliceModeBtn.textContent = 'Slicing Mode';
        slicingControls.classList.add('hidden');
        // Disable clipping on all materials
        if (currentModel) {
          currentModel.traverse(obj => {
            if (obj.isMesh && obj.material) {
              const materials = Array.isArray(obj.material) ? obj.material : [obj.material];
              materials.forEach(mat => {
                mat.clippingPlanes = [];
                mat.needsUpdate = true;
              });
            }
          });
        }
      }
    });
    
    function updateSlicing() {
      if (!slicingEnabled || !currentModel) return;
      
      const pos = parseFloat(slicePosition.value);
      const axis = sliceAxis.value;
      
      // Set plane normal based on axis
      if (axis === 'x') {
        clippingPlane.normal.set(sliceDirection, 0, 0);
      } else if (axis === 'y') {
        clippingPlane.normal.set(0, sliceDirection, 0);
      } else if (axis === 'z') {
        clippingPlane.normal.set(0, 0, sliceDirection);
      }
      
      clippingPlane.constant = pos;
      
      // Apply clipping plane to all materials
      currentModel.traverse(obj => {
        if (obj.isMesh && obj.material) {
          const materials = Array.isArray(obj.material) ? obj.material : [obj.material];
          materials.forEach(mat => {
            mat.clippingPlanes = [clippingPlane];
            mat.clipShadows = true;
            mat.needsUpdate = true;
          });
        }
      });
    }
    
    slicePosition.addEventListener('input', updateSlicing);
    sliceAxis.addEventListener('change', updateSlicing);
    
    flipSliceBtn.addEventListener('click', () => {
      sliceDirection *= -1;
      updateSlicing();
    });
    
    // Zoom controls
    const zoomInBtn = document.getElementById('zoomIn');
    const zoomOutBtn = document.getElementById('zoomOut');
    
    zoomInBtn.addEventListener('click', () => {
      const direction = new THREE.Vector3();
      camera.getWorldDirection(direction);
      const distance = camera.position.distanceTo(controls.target);
      const zoomAmount = distance * 0.2;
      camera.position.addScaledVector(direction, zoomAmount);
      controls.update();
    });
    
    zoomOutBtn.addEventListener('click', () => {
      const direction = new THREE.Vector3();
      camera.getWorldDirection(direction);
      const distance = camera.position.distanceTo(controls.target);
      const zoomAmount = distance * 0.2;
      camera.position.addScaledVector(direction, -zoomAmount);
      controls.update();
    });

    window.addEventListener('resize', () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });

    function animate() {
      requestAnimationFrame(animate);
      controls.update();
      renderer.render(scene, camera);
    }
    animate();
  </script>
</body>
</html>
